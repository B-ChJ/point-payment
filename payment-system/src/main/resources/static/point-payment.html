<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì¸íŠ¸ ê²°ì œ ì‹œìŠ¤í…œ ì‹œë®¬ë ˆì´ì…˜</title>

    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: 20px auto; padding: 30px; border: 1px solid #ddd; border-radius: 12px; background-color: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; }
        h2 { color: #34495e; margin-top: 25px; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; }
        .form-group label { flex: 1; margin-right: 15px; font-weight: bold; color: #34495e; }
        .form-group input[type="number"], .form-group input[type="text"] { flex: 3; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 12px 25px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; margin-top: 10px; }
        button:hover { background-color: #2980b9; }
        .status { margin-top: 20px; padding: 15px; border: 2px solid #bdc3c7; border-radius: 6px; background-color: #ecf0f1; white-space: pre-wrap; word-wrap: break-word; font-size: 14px; line-height: 1.6; }
        .status.error { border-color: #e74c3c; color: #c0392b; background-color: #fceae9; }
        .status.success { border-color: #27ae60; color: #27ae60; background-color: #e9f7ef; }
        .warning-box { background-color: #fcf8e3; border: 1px solid #fbeed5; color: #c09853; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’³ í¬ì¸íŠ¸/ê²°ì œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    <p>ë¡œê·¸ì¸ ìƒíƒœë¥¼ ê°€ì •í•˜ë©°, JWT í† í°ì€ Local Storageì˜ **`authToken`**ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>

    <div id="tokenWarning" class="warning-box" style="display:none;">
        ğŸš¨ **í† í° ëˆ„ë½ ê²½ê³ :** Local Storageì—ì„œ **'authToken'**ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í˜¸ì¶œ ì „ì— **ë¡œê·¸ì¸**ì´ í•„ìš”í•©ë‹ˆë‹¤.
    </div>

    <hr>

    <h2>ğŸ”‘ ê¸°ë³¸ ì •ë³´</h2>
    <div class="form-group">
        <label for="orderId">ê²°ì œí•  ì£¼ë¬¸ ID / ì¡°íšŒí•  ê²°ì œ ID</label>
        <input type="number" id="orderId" placeholder="ì£¼ë¬¸/ê²°ì œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <div class="form-group">
        <label for="userIdInput">ì‚¬ìš©ì ID</label>
        <input type="number" id="userIdInput" placeholder="ì£¼ë¬¸ì ID (ì˜ˆ: 1)">
    </div>

    <hr>

    <h2>ğŸ›’ ê²°ì œ ì •ë³´</h2>

    <button id="applyOrderBtn">âœ… ì£¼ë¬¸ ì •ë³´ ë° í¬ì¸íŠ¸ ì ìš©</button>

    <div class="form-group" style="margin-top: 20px;">
        <label for="totalAmount">ì£¼ë¬¸ ì´ ê¸ˆì•¡</label>
        <input type="number" id="totalAmount" value="0" readonly>
    </div>
    <div class="form-group">
        <label for="userPoint">ë³´ìœ  í¬ì¸íŠ¸</label>
        <input type="number" id="userPoint" value="0" readonly>
    </div>
    <div class="form-group">
        <label for="points">ì‚¬ìš© í¬ì¸íŠ¸</label>
        <input type="number" id="points" placeholder="ì‚¬ìš©í•  í¬ì¸íŠ¸ ê¸ˆì•¡">
    </div>

    <div style="font-size: 1.1em; font-weight: bold; margin-top: 15px;">
        <span>ê²°ì œ ê³„ì‚°: </span>
        <span id="formulaDisplay"></span>
        <span id="finalAmountDisplay"></span>
    </div>

    <button id="paymentBtn" style="background-color: #e74c3c;">ğŸ’° ìµœì¢… ê²°ì œ ì§„í–‰</button>

    <hr>

    <h2>ğŸ“Š ê²°ê³¼ ìƒíƒœ ë¡œê·¸</h2>
    <div id="paymentStatus" class="status">ëŒ€ê¸° ì¤‘...</div>

    <hr>
    <h2>ê¸°íƒ€ API í…ŒìŠ¤íŠ¸</h2>
    <button id="getOrdersBtn">ğŸ§¾ íŠ¹ì • ì£¼ë¬¸ ID ì¡°íšŒ (ë‹¨ì¼)</button>
    <button id="getPaymentsBtn">ğŸ’³ íŠ¹ì • ê²°ì œ ID ì¡°íšŒ (ë‹¨ì¼)</button>
    <button id="refundBtn" style="background-color: #f39c12;">ğŸ’¸ í™˜ë¶ˆ ìš”ì²­</button>
    <button id="logoutBtn" style="background-color: #95a5a6;">ë¡œê·¸ì•„ì›ƒ</button>
</div>
<script>
    const API_BASE_URL = "http://localhost:8080";
    // PortOne ìƒì  ID ë° ì±„ë„ í‚¤ (ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ í‚¤)
    const STORE_ID = 'store-2e4cc615-9eb8-438c-8f26-8513104294c7';
    const CHANNEL_KEY = 'channel-key-2ea966c0-11ad-4095-8cc8-a78deee89506';

    // DOM Elements
    const totalAmountInput = document.getElementById('totalAmount');
    const pointsInput = document.getElementById('points');
    const userPointInput = document.getElementById('userPoint');
    const finalAmountDisplay = document.getElementById('finalAmountDisplay');
    const formulaDisplay = document.getElementById('formulaDisplay');
    const getOrdersBtn = document.getElementById('getOrdersBtn');
    const getPaymentsBtn = document.getElementById('getPaymentsBtn');
    const paymentBtn = document.getElementById('paymentBtn');
    const applyOrderBtn = document.getElementById('applyOrderBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const refundBtn = document.getElementById('refundBtn');
    const paymentStatusDiv = document.getElementById('paymentStatus');
    const tokenWarningDiv = document.getElementById('tokenWarning');


    // -----------------------------------------------------------
    // ğŸš¨ í† í° ë° ì¸ì¦ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° (authToken í‚¤ ì‚¬ìš©)
    // -----------------------------------------------------------

    function localGetAuthToken() {
        const token = localStorage.getItem('authToken');

        if (!token) {
            tokenWarningDiv.style.display = 'block';
            console.error("JWT í† í° (authToken)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í˜¸ì¶œ ì‹¤íŒ¨ ì˜ˆìƒ.");
        } else {
            tokenWarningDiv.style.display = 'none';
        }
        return token;
    }

    function createAuthHeaders() {
        const token = localGetAuthToken();
        if (!token) return null;

        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    /**
     * ë²”ìš© ì¸ì¦ Fetch í•¨ìˆ˜ (ì‘ë‹µ ë³¸ë¬¸ì„ í•œ ë²ˆë§Œ ì½ë„ë¡ ìˆ˜ì •)
     */
    async function authenticatedFetch(url, options = {}) {
        const headers = createAuthHeaders();
        if (!headers) {
            const tokenError = new Error("JWT í† í°(authToken)ì´ ì—†ì–´ API ìš”ì²­ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
            paymentStatusDiv.innerHTML = `Error: ${tokenError.message}`;
            paymentStatusDiv.classList.add('error');
            throw tokenError;
        }
        options.headers = headers;

        const response = await fetch(url, options);

        const contentType = response.headers.get('content-type');
        const isJson = contentType && contentType.includes('application/json');

        let responseBody = null;
        try {
            // ë³¸ë¬¸ì„ í•œ ë²ˆë§Œ ì½ìŠµë‹ˆë‹¤.
            if (isJson) {
                responseBody = await response.json();
            } else {
                responseBody = await response.text();
            }
        } catch (e) {
            // ë³¸ë¬¸ì´ ë¹„ì–´ìˆê±°ë‚˜ íŒŒì‹± ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì²˜ë¦¬
            responseBody = response.statusText || 'ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ';
        }

        if (!response.ok) {
            let errorMessage = '';
            if (typeof responseBody === 'object' && responseBody !== null && responseBody.message) {
                errorMessage = responseBody.message;
            } else if (typeof responseBody === 'string') {
                errorMessage = responseBody.substring(0, 100);
            } else {
                errorMessage = response.statusText || JSON.stringify(responseBody);
            }

            paymentStatusDiv.innerHTML = `Error: HTTP ìƒíƒœ ì½”ë“œ ${response.status}\në©”ì‹œì§€: ${errorMessage}`;
            paymentStatusDiv.classList.add('error');
            throw new Error(`HTTP Error! status: ${response.status}, message: ${response.statusText}`);
        }

        return responseBody;
    }

    document.addEventListener('DOMContentLoaded', localGetAuthToken);


    // -----------------------------------------------------------
    // ì£¼ë¬¸/ê²°ì œ í”Œë¡œìš° í•¨ìˆ˜
    // -----------------------------------------------------------

    function calculateFinalAmount() {
        const total = parseFloat(totalAmountInput.value) || 0;
        const points = parseFloat(pointsInput.value) || 0;
        const final = total - points;

        if (totalAmountInput.value === '' && pointsInput.value === '') {
            formulaDisplay.textContent = '';
            finalAmountDisplay.textContent = '';
        } else {
            formulaDisplay.textContent = `${total.toLocaleString()}ì› - ${points.toLocaleString()}ì›`;
            finalAmountDisplay.textContent = `= ${final.toLocaleString()}ì›`;
        }
    }

    async function requestPaymentReady(orderId, usePoint) {
        // ì£¼ë¬¸ IDë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ì œ ì¤€ë¹„ ìš”ì²­ (PaymentControllerì— ì •ì˜ëœ ê²½ë¡œ)
        const endpoint = `${API_BASE_URL}/api/payments/${orderId}/payments`;
        const requestBody = { usePoint: usePoint };

        paymentStatusDiv.innerHTML += `\n[1/3] ğŸŸ¢ ê²°ì œ ì¤€ë¹„ API í˜¸ì¶œ ì¤‘...`;
        const data = await authenticatedFetch(endpoint, {
            method: 'POST',
            body: JSON.stringify(requestBody)
        });

        console.log("ë°±ì—”ë“œ ê²°ì œ ì¤€ë¹„ ì‘ë‹µ (readyData):", data);

        paymentStatusDiv.innerHTML += `\n[1/3] âœ… ê²°ì œ ì¤€ë¹„ ì„±ê³µ\n  - Payment ID: ${data.paymentId}\n  - Payment Key: ${data.paymentKey}\n  - ìµœì¢… ê²°ì œ ê¸ˆì•¡: ${data.amount} KRW`;
        return data;
    }

    async function requestPortOnePayment(readyData, finalAmount) {
        paymentStatusDiv.innerHTML += `\n[2/3] ğŸŒ PortOne ê²°ì œì°½ ìš”ì²­ ì¤‘...`;

        const paymentIdString = String(readyData.paymentId);
        const paymentKeyString = String(readyData.paymentKey);

        const response = await PortOne.requestPayment({
            storeId: STORE_ID,
            channelKey: CHANNEL_KEY,
            paymentId: paymentIdString,
            paymentKey: paymentKeyString,
            orderName: readyData.orderName || `ì£¼ë¬¸ë²ˆí˜¸ ${document.getElementById('orderId').value}`,
            totalAmount: finalAmount,
            currency: 'KRW',
            payMethod: 'CARD',
            customer: {
                fullName: 'í…ŒìŠ¤í„° ì‚¬ìš©ì',
                phoneNumber: '010-1234-5678',
                email: 'test@example.com'
            },
            redirectUrl: window.location.origin + window.location.pathname,
        });

        console.log("PortOne ê²°ì œ ì‘ë‹µ:", response);

        if (response.code != null) {
            throw new Error(`PortOne ê²°ì œ ì‹¤íŒ¨ [Code: ${response.code}]: ${response.message || 'ì‚¬ìš©ì ì·¨ì†Œ'}`);
        }

        if (response.paymentId) {
            paymentStatusDiv.innerHTML += `\n[2/3] âœ… PortOne ê²°ì œ ì„±ê³µ (Payment ID íšë“)`;
            return response;
        } else {
            // PortOne SDKì—ì„œ paymentKey ëŒ€ì‹  paymentIdë¥¼ ì‘ë‹µ ë³¸ë¬¸ì— ë‹´ì•„ì£¼ëŠ” ê²½ìš°ê°€ ìˆì–´ ìˆ˜ì • í•„ìš”
            // ì—¬ê¸°ì„œëŠ” ì„œë²„ ê²€ì¦ì— í•„ìš”í•œ paymentId (ì„œë²„ì—ì„œ ë°œê¸‰í•œ PaymentKeyê°€ ì•„ë‹˜)ê°€ PortOne ì‘ë‹µì— ì—†ìŒì„ ê°€ì •í•©ë‹ˆë‹¤.
            throw new Error("PortOne ê²°ì œëŠ” ì„±ê³µí–ˆì§€ë§Œ paymentIdë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì„œë²„ ê²°ì œ ê²€ì¦ API í˜¸ì¶œ (PaymentControllerì˜ /complete ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •)
    async function requestPaymentVerification(paymentKey) {
        const endpoint = `${API_BASE_URL}/api/payments/complete?paymentKey=${paymentKey}`;

        paymentStatusDiv.innerHTML += `\n[3/3] ğŸ” ê²°ì œ ê²€ì¦ (Verification) API í˜¸ì¶œ ì¤‘...`;

        const data = await authenticatedFetch(endpoint, {
            method: 'POST'
        });

        paymentStatusDiv.innerHTML += `\n[3/3] âœ… ê²°ì œ ê²€ì¦ ë° ì™„ë£Œ ì„±ê³µ\n  - ìµœì¢… ìƒíƒœ: **${data.status}**\n  - ìµœì¢… ê¸ˆì•¡: ${data.totalAmount} KRW`;

        paymentStatusDiv.classList.add('success');
        paymentStatusDiv.innerHTML += `\n\n**ğŸ‰ ëª¨ë“  ê²°ì œ í”Œë¡œìš°ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**`;
    }

    // -----------------------------------------------------------
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    // -----------------------------------------------------------

    // ê¸ˆì•¡ ê³„ì‚° ë¡œì§
    pointsInput.addEventListener('input', calculateFinalAmount);
    totalAmountInput.addEventListener('input', calculateFinalAmount);


    applyOrderBtn.addEventListener('click', async function () {
        const orderId = document.getElementById('orderId').value;
        const userId = document.getElementById('userIdInput').value;

        if (!orderId || !userId) {
            alert("ì£¼ë¬¸ IDì™€ ì‚¬ìš©ì IDë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        try {
            // ë‹¨ì¼ ì£¼ë¬¸ ì¡°íšŒ (OrderControllerì— êµ¬í˜„ë˜ì–´ ìˆìŒ)
            const orderData = await authenticatedFetch(`${API_BASE_URL}/api/orders/${orderId}`, { method: "GET" });
            totalAmountInput.value = orderData.totalAmount || 0;

            // í¬ì¸íŠ¸ ì¡°íšŒ (userId ì‚¬ìš©)
            const pointData = await authenticatedFetch(`${API_BASE_URL}/api/users/${userId}/points`, { method: "GET" });
            userPointInput.value = pointData.points || 0;

            calculateFinalAmount();

            paymentStatusDiv.innerHTML = `âœ… ì£¼ë¬¸ ì •ë³´ (ID: ${orderId}) ì™€ í¬ì¸íŠ¸ (${pointData.points}ì ) ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            paymentStatusDiv.classList.remove('error', 'success');

        } catch (e) {
            console.error(e);
            alert(`ì •ë³´ ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
        }
    });

    paymentBtn.addEventListener('click', async function (e) {
        e.preventDefault();
        const orderId = document.getElementById('orderId').value;
        const total = parseFloat(totalAmountInput.value) || 0;
        const points = parseFloat(pointsInput.value) || 0;
        const finalAmount = total - points;
        const usePoint = points > 0;

        if (!orderId || total <= 0 || finalAmount < 0 || points > parseFloat(userPointInput.value || 0)) {
            alert("ì£¼ë¬¸ ID, ê¸ˆì•¡, í¬ì¸íŠ¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            return;
        }

        // PortOneì´ 0ì› ê²°ì œë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„ (ì¼ë°˜ì ìœ¼ë¡œ PGì‚¬ëŠ” 100ì› ì´ìƒì˜ ì‹¤ê²°ì œë¥¼ ìš”êµ¬)
        if (finalAmount <= 0) {
            alert("PortOne ì—°ë™ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ìµœì¢… ê²°ì œ ê¸ˆì•¡ì€ 0ì›ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        paymentStatusDiv.innerHTML = `[0/3] ê²°ì œ ê¸ˆì•¡ ${finalAmount.toLocaleString()}ì›ìœ¼ë¡œ ê²°ì œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`;
        paymentStatusDiv.classList.remove('error', 'success');

        try {
            const readyData = await requestPaymentReady(orderId, usePoint);
            const portOneResponse = await requestPortOnePayment(readyData, finalAmount);

            // PortOne ì‘ë‹µì˜ paymentId (PGì‚¬ ID)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì— ê²€ì¦ ìš”ì²­
            await requestPaymentVerification(portOneResponse.paymentId);

        } catch (error) {
            console.error("ê²°ì œ í”Œë¡œìš° ì˜¤ë¥˜:", error);
            paymentStatusDiv.innerHTML = `ê²°ì œ í”Œë¡œìš° ì˜¤ë¥˜: ${error.message}`;
            paymentStatusDiv.classList.add('error');
        }
    });

    // -----------------------------------------------------------
    // ê¸°íƒ€ API ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¡°íšŒ ë° í™˜ë¶ˆ)
    // -----------------------------------------------------------

    // ğŸ§¾ íŠ¹ì • ì£¼ë¬¸ ID ì¡°íšŒ (GET /api/orders/{orderId})
    getOrdersBtn.addEventListener('click', async function () {
        const orderId = document.getElementById('orderId').value;
        if (!orderId) {
            alert("ì£¼ë¬¸ ë‚´ì—­ì„ ì¡°íšŒí•˜ë ¤ë©´ ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const endpoint = `${API_BASE_URL}/api/orders/${orderId}`;

        paymentStatusDiv.innerHTML = `[ì¡°íšŒ] ğŸ” ì£¼ë¬¸ ID ${orderId}ì˜ ìƒì„¸ ë‚´ì—­ ì¡°íšŒ ìš”ì²­ ì¤‘...`;
        paymentStatusDiv.classList.remove('error', 'success');

        try {
            const data = await authenticatedFetch(endpoint, { method: "GET" });

            paymentStatusDiv.innerHTML = `âœ… ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ ì„±ê³µ (ID: ${data.orderId})\n\n${JSON.stringify(data, null, 2)}`;
            paymentStatusDiv.classList.add('success');
            console.log("ë‹¨ì¼ ì£¼ë¬¸ ë‚´ì—­:", data);
            alert(`ì£¼ë¬¸ ID ${orderId}ì˜ ìƒì„¸ ë‚´ì—­ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤. (ê²°ê³¼ ë¡œê·¸ í™•ì¸)`);

        } catch (e) {
            console.error("ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:", e);
            alert(`âŒ ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨. ì˜¤ë¥˜: ${e.message}`);
            paymentStatusDiv.innerHTML = `ì¡°íšŒ ì‹¤íŒ¨: ${e.message}`;
            paymentStatusDiv.classList.add('error');
        }
    });

    // ğŸ’³ íŠ¹ì • ê²°ì œ ID ì¡°íšŒ (GET /api/payments/{paymentId})
    getPaymentsBtn.addEventListener('click', async function () {
        const paymentId = document.getElementById('orderId').value; // ì…ë ¥ í•„ë“œë¥¼ Payment IDë¡œ ì‚¬ìš©

        if (!paymentId) {
            alert("ê²°ì œ ë‚´ì—­ì„ ì¡°íšŒí•˜ë ¤ë©´ ê²°ì œ ID (ì…ë ¥ë€ ì‚¬ìš©)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        paymentStatusDiv.innerHTML = `[ì¡°íšŒ] ğŸ” íŠ¹ì • ê²°ì œ ID ${paymentId} ì¡°íšŒ ìš”ì²­ ì¤‘...`;
        paymentStatusDiv.classList.remove('error', 'success');

        try {
            const endpoint = `${API_BASE_URL}/api/payments/${paymentId}`;
            const data = await authenticatedFetch(endpoint, { method: "GET" });

            paymentStatusDiv.innerHTML = `âœ… ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì„±ê³µ (ID: ${data.paymentId})\n\n${JSON.stringify(data, null, 2)}`;
            paymentStatusDiv.classList.add('success');
            console.log("ë‹¨ì¼ ê²°ì œ ë‚´ì—­:", data);
            alert(`ê²°ì œ ID ${paymentId}ì˜ ë‚´ì—­ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤. (ê²°ê³¼ ë¡œê·¸ í™•ì¸)`);

        } catch (e) {
            console.error("ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:", e);
            alert(`âŒ ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨. ì˜¤ë¥˜: ${e.message}`);
            paymentStatusDiv.innerHTML = `ì¡°íšŒ ì‹¤íŒ¨: ${e.message}`;
            paymentStatusDiv.classList.add('error');
        }
    });

    // ğŸ’¸ í™˜ë¶ˆ ìš”ì²­ (POST /api/payments/{paymentId}/refund) - RefundController ê²½ë¡œì— ë§ì¶¤
    refundBtn.addEventListener('click', async function () {
        const paymentId = document.getElementById('orderId').value; // ì…ë ¥ í•„ë“œë¥¼ Payment IDë¡œ ì‚¬ìš©

        if (!paymentId) {
            alert("í™˜ë¶ˆí•  ê²°ì œ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // RefundServiceëŠ” í˜„ì¬ ë¶€ë¶„ í™˜ë¶ˆ ë¡œì§ì´ ì—†ìœ¼ë¯€ë¡œ, ê¸ˆì•¡ ì…ë ¥ í”„ë¡¬í”„íŠ¸ ëŒ€ì‹  ì‚¬ìœ ë§Œ ìš”ì²­í•©ë‹ˆë‹¤.
        const reason = "í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸ ì „ì²´ í™˜ë¶ˆ ìš”ì²­";

        // ê²½ë¡œ ìˆ˜ì •: /api/payments/{paymentId}/refund
        const endpoint = `${API_BASE_URL}/api/payments/${paymentId}/refund`;
        const requestBody = {
            // ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” paymentIdë¥¼ @PathVariableë¡œ ë°›ìœ¼ë¯€ë¡œ, bodyì—ëŠ” reasonë§Œ ë³´ëƒ…ë‹ˆë‹¤.
            reason: reason
        };

        paymentStatusDiv.innerHTML = `[í™˜ë¶ˆ] ğŸ’¸ ê²°ì œ ID ${paymentId}ì— ëŒ€í•œ ì „ì²´ í™˜ë¶ˆ ìš”ì²­ ì¤‘...`;
        paymentStatusDiv.classList.remove('error', 'success');

        try {
            const data = await authenticatedFetch(endpoint, {
                method: 'POST',
                body: JSON.stringify(requestBody)
            });

            paymentStatusDiv.innerHTML = `âœ… í™˜ë¶ˆ ìš”ì²­ ì„±ê³µ\n  - ê²°ì œ ID: ${paymentId}\n  - **ìµœì¢… ìƒíƒœ: ${data.status}**\n  - **í™˜ë¶ˆ ê¸ˆì•¡: ${data.amount.toLocaleString()} KRW**\n\n${JSON.stringify(data, null, 2)}`;

            if (data.status === 'COMPLETED') { // Refund.RefundStatus.COMPLETED
                paymentStatusDiv.classList.add('success');
                alert(`ğŸ‰ í™˜ë¶ˆì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                paymentStatusDiv.classList.add('error');
                alert(`âš ï¸ í™˜ë¶ˆ ìš”ì²­ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ìµœì¢… ìƒíƒœê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤. (ìƒíƒœ: ${data.status})`);
            }

        } catch (e) {
            console.error("í™˜ë¶ˆ í”Œë¡œìš° ì˜¤ë¥˜:", e);
            alert(`âŒ í™˜ë¶ˆ ìš”ì²­ ì‹¤íŒ¨. ì˜¤ë¥˜: ${e.message}`);
            paymentStatusDiv.innerHTML = `í™˜ë¶ˆ í”Œë¡œìš° ì˜¤ë¥˜: ${e.message}`;
            paymentStatusDiv.classList.add('error');
        }
    });


    // ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    logoutBtn.addEventListener('click', async function () {
        const currentToken = localGetAuthToken();
        if (!currentToken) {
            alert("ì´ë¯¸ ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = `${API_BASE_URL}/login.html`;
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/logout`, {
                method: 'POST',
                headers: createAuthHeaders(),
            });

            if (response.ok || response.status === 401) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');

                alert("ë¡œê·¸ì•„ì›ƒì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = `${API_BASE_URL}/login.html`;
            } else {
                alert(`ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
            }

        } catch (e) {
            console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", e);
            alert("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ë¡œê·¸ì•„ì›ƒ)");
        }
    });

    calculateFinalAmount();
</script>
</body>
</html>